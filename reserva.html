<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Detalles del Destino</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --main-bg-color: #ffffff;
            --card-bg-color: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
        }

        html.dark {
            --bg-color: #121212;
            --main-bg-color: #1E1E1E;
            --card-bg-color: #2D2D2D;
            --text-primary: #E0E0E0;
            --text-secondary: #9CA3AF;
            --border-color: #374151;
        }

        body { 
            background-color: var(--bg-color); 
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            padding-bottom: 100px; /* Espacio para el footer fijo */
        }
        .header-gradient { background-image: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 50%); }
        #booking-modal { transition: opacity 0.3s ease-in-out; }
        
        /* Estilos para modo oscuro */
        .content-section {
            background-color: var(--main-bg-color);
        }
        .modal-content {
            background-color: var(--main-bg-color);
        }
        .form-input {
            background-color: var(--bg-color);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        #map-container iframe {
            filter: grayscale(0);
        }
        html.dark #map-container iframe {
            filter: grayscale(1) invert(0.9) contrast(0.8);
        }
    </style>
     <!-- Script para aplicar el tema INMEDIATAMENTE y evitar parpadeo -->
    <script>
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>
<body>

    <main class="w-full mx-auto">
        <div class="h-80 relative">
            <img id="detail-image" src="https://placehold.co/400x320/cccccc/ffffff?text=Loading..." alt="Imagen del destino" class="absolute inset-0 w-full h-full object-cover">
            <div class="absolute inset-0 header-gradient"></div>
            <div class="absolute top-4 left-4 flex items-center w-[calc(100%-2rem)] justify-between">
                <a href="javascript:history.back()" class="bg-white/80 dark:bg-black/50 backdrop-blur-sm text-gray-800 dark:text-gray-200 w-10 h-10 rounded-full flex items-center justify-center shadow-md">
                    <i class="bi bi-chevron-left"></i>
                </a>
                <button class="bg-white/80 dark:bg-black/50 backdrop-blur-sm text-gray-800 dark:text-gray-200 w-10 h-10 rounded-full flex items-center justify-center shadow-md">
                    <i class="bi bi-share"></i>
                </button>
            </div>
        </div>
        <div class="p-5 content-section rounded-t-2xl -mt-5 relative">
            <h1 id="detail-title" class="text-3xl font-bold">Cargando...</h1>
            <div class="flex items-center text-secondary mt-2">
                <i class="bi bi-geo-alt-fill mr-2"></i>
                <p id="detail-location">Cargando ubicación...</p>
            </div>
            <hr class="my-4 border-[var(--border-color)]">
            <h2 class="text-lg font-semibold mb-2">Descripción</h2>
            <p id="detail-description" class="text-secondary leading-relaxed">Cargando descripción...</p>
            
            <!-- ================== NUEVA SECCIÓN DE MAPA ================== -->
            <hr class="my-4 border-[var(--border-color)]">
            <h2 class="text-lg font-semibold mb-2">Ubicación</h2>
            <div id="map-container" class="w-full h-64 rounded-lg bg-gray-200 dark:bg-gray-700 flex items-center justify-center overflow-hidden">
                <p class="text-secondary">Cargando mapa...</p>
            </div>
            <div id="directions-container" class="mt-4 hidden">
                 <a id="directions-link" href="#" target="_blank" class="block w-full text-center bg-blue-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-blue-700 transition">
                    Ver ruta y distancia
                 </a>
             </div>
             <!-- ========================================================== -->

        </div>
    </main>

    <footer class="fixed bottom-0 left-0 right-0 p-4 border-t content-section flex justify-between items-center z-10">
        <div>
            <p class="text-secondary text-sm">Precio</p>
            <p class="font-bold text-xl">$150 <span class="font-normal text-sm text-secondary">/persona</span></p>
        </div>
        <button id="book-now-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-blue-700 transition">
            Reservar
        </button>
    </footer>

    <!-- Modal de Reserva -->
    <div id="booking-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="modal-content rounded-2xl shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Confirmar Reserva</h2>
                <button id="close-modal-btn" class="text-secondary hover:text-primary"><i class="bi bi-x-lg text-2xl"></i></button>
            </div>
            <form id="booking-form" class="space-y-4">
                <input type="hidden" id="idLugar" name="idLugar">
                <div>
                    <label for="duiCliente" class="block text-sm font-medium text-secondary">DUI del Cliente</label>
                    <input type="text" id="duiCliente" name="duiCliente" class="form-input mt-1 block w-full p-3 border rounded-md shadow-sm" placeholder="00000000-0" required>
                </div>
                <div>
                    <label for="cantidadPersonas" class="block text-sm font-medium text-secondary">Cantidad de Personas</label>
                    <input type="number" id="cantidadPersonas" name="cantidadPersonas" class="form-input mt-1 block w-full p-3 border rounded-md shadow-sm" min="1" value="1" required>
                </div>
                <div>
                    <label for="pickupAddress" class="block text-sm font-medium text-secondary">Dirección de Recogida</label>
                    <input type="text" id="pickupAddress" name="pickupAddress" class="form-input mt-1 block w-full p-3 border rounded-md shadow-sm" placeholder="Ej: Calle La Mascota, San Salvador" required>
                </div>
                 <div>
                    <label for="horaRecogida" class="block text-sm font-medium text-secondary">Fecha y Hora de Recogida</label>
                    <input type="datetime-local" id="horaRecogida" name="horaRecogida" class="form-input mt-1 block w-full p-3 border rounded-md shadow-sm" required>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-btn" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            let lugarData = null;

            const mapContainer = document.getElementById('map-container');
            const directionsContainer = document.getElementById('directions-container');
            const directionsLink = document.getElementById('directions-link');

            const showMap = (address) => {
                const encodedAddress = encodeURIComponent(address);
                const mapUrl = `https://maps.google.com/maps?q=${encodedAddress}&t=&z=13&ie=UTF8&iwloc=&output=embed`;
                mapContainer.innerHTML = `<iframe src="${mapUrl}" width="100%" height="100%" frameborder="0" style="border:0;" allowfullscreen="" aria-hidden="false" tabindex="0"></iframe>`;
            };

            if (dataParam) {
                try {
                    lugarData = JSON.parse(decodeURIComponent(dataParam));
                    document.getElementById('detail-image').src = lugarData.imagenUrl || 'https://placehold.co/400x320/cccccc/ffffff?text=No+Image';
                    document.getElementById('detail-image').alt = `Imagen de ${lugarData.nombreLugar}`;
                    document.getElementById('detail-title').textContent = lugarData.nombreLugar;
                    document.getElementById('detail-location').textContent = lugarData.ubicacion;
                    document.getElementById('detail-description').textContent = lugarData.descripcion || 'No hay descripción disponible.';

                    // Mostrar el mapa del destino
                    showMap(lugarData.ubicacion);

                    // Pedir la ubicación del usuario para la ruta
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition((position) => {
                            const userLat = position.coords.latitude;
                            const userLng = position.coords.longitude;
                            const destinationAddress = encodeURIComponent(lugarData.ubicacion);
                            directionsLink.href = `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${destinationAddress}`;
                            directionsContainer.classList.remove('hidden');
                        }, (error) => {
                            console.warn("El usuario denegó el acceso a la ubicación.", error.message);
                            mapContainer.querySelector('p')?.remove();
                        });
                    } else {
                        console.warn("La geolocalización no es soportada por este navegador.");
                    }

                } catch (error) {
                    console.error('Error al parsear los datos del lugar:', error);
                    document.getElementById('detail-title').textContent = 'Error al cargar';
                    mapContainer.innerHTML = `<p class="text-secondary">No se pudo cargar el mapa.</p>`;
                }
            } else {
                 document.getElementById('detail-title').textContent = 'Destino no encontrado';
                 mapContainer.innerHTML = `<p class="text-secondary">Ubicación no disponible.</p>`;
            }

            const bookingModal = document.getElementById('booking-modal');
            const bookNowBtn = document.getElementById('book-now-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const bookingForm = document.getElementById('booking-form');

            const showModal = () => {
                bookingModal.classList.remove('hidden');
                setTimeout(() => bookingModal.classList.remove('opacity-0'), 10);
            };
            const hideModal = () => {
                bookingModal.classList.add('opacity-0');
                setTimeout(() => bookingModal.classList.add('hidden'), 300);
            };

            bookNowBtn.addEventListener('click', showModal);
            closeModalBtn.addEventListener('click', hideModal);
            cancelBtn.addEventListener('click', hideModal);

            bookingForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(bookingForm);
                const reserva = {
                    duiCliente: formData.get('duiCliente'),
                    cantidadPersonas: formData.get('cantidadPersonas'),
                    pickup_address: formData.get('pickupAddress'),
                    horaRecogida: formData.get('horaRecogida'),
                    idLugar: lugarData ? lugarData.idLugar : null
                };
                console.log('Datos de la reserva:', reserva);
                hideModal();
                Swal.fire({
                    title: '¡Reserva Confirmada!',
                    text: `Tu viaje a ${lugarData.nombreLugar} ha sido agendado. Recibirás una confirmación por correo.`,
                    icon: 'success',
                    confirmButtonText: '¡Excelente!',
                    timer: 3000, // La alerta se cierra sola después de 3 segundos
                    timerProgressBar: true
                }).then(() => {
                    window.location.href = 'planes.html'; // Redirige al usuario después de la confirmación
                });
            });
        });
    </script>
<nav class="fixed-nav">
    <ul>
        <span id="nav-indicator"></span>
        <li class="list" data-page="descubrir.html"><a href="descubrir.html"><svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 100-18 9 9 0 000 18z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.91 8.09l-3.82 3.82-3.82-3.82 3.82-3.82 3.82 3.82z" /></svg></a></li>
        <li class="list" data-page="planes.html"><a href="planes.html"><svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg></a></li>
        <li class="list" data-page="mapa.html"><a href="mapa.html"><svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 3l6-3" /></svg></a></li>
        <li class="list" data-page="perfil.html"><a href="perfil.html"><svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg></a></li>
    </ul>
</nav>
</body>
</html>

